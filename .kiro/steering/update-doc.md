---
inclusion: always
---

# 文档同步更新规范

## 核心原则

当根据新需求修改代码时，必须同步更新相关文档，确保文档与代码实现保持一致。

## 必须更新的文档

### 1. 设计文档 (design.md)

当以下情况发生时，必须更新设计文档：

#### 架构变更
- 添加、删除或修改系统组件
- 改变组件之间的交互方式
- 引入新的技术栈或框架
- 修改数据流或控制流

#### 接口变更
- 修改公共 API 的签名
- 添加或删除接口方法
- 改变接口的行为或语义
- 修改数据模型的结构

#### 数据模型变更
- 添加、删除或修改数据结构
- 改变数据验证规则
- 修改数据持久化方式
- 调整数据关系

#### 错误处理变更
- 添加新的错误类型
- 修改错误处理策略
- 改变错误传播方式

#### 正确性属性变更
- 实现新的正确性属性
- 修改现有属性的定义
- 发现属性不再适用

**更新要求：**
- 在相应章节中记录变更
- 说明变更的原因和影响
- 更新相关的图表和示例
- 确保正确性属性仍然有效

### 2. 测试文档

当以下情况发生时，必须更新测试：

#### 功能变更
- 添加新功能时，编写对应的单元测试和属性测试
- 修改现有功能时，更新相关测试用例
- 删除功能时，移除或标记废弃的测试

#### 属性测试
- 实现设计文档中定义的正确性属性
- 每个属性必须有对应的属性测试
- 测试必须标注验证的需求编号：`**Validates: Requirements X.Y**`
- 确保测试运行至少 100 次迭代

#### 单元测试
- 为新的函数、类、模块编写单元测试
- 测试重要的边界条件和错误情况
- 使用描述性的测试名称

#### 测试失败处理
- 如果测试揭示了代码中的 bug，修复代码而不是修改测试
- 如果需求变更导致测试失败，同时更新需求文档、设计文档和测试

### 3. 需求文档 (requirements.md)

当以下情况发生时，考虑更新需求文档：

- 发现原需求描述不清晰或有歧义
- 需求范围发生变化
- 添加新的验收标准
- 发现遗漏的需求

**注意：** 需求变更应该谨慎，通常需要与用户确认。

## 更新工作流

### 步骤 1：代码实现
- 根据需求实现代码变更
- 遵循代码组织规范（文件不超过 300 行）

### 步骤 2：更新设计文档
- 检查设计文档的相关章节
- 记录架构、接口、数据模型的变更
- 更新或添加正确性属性（如果适用）
- 确保文档准确反映当前实现

### 步骤 3：更新测试
- 为新功能编写单元测试
- 为正确性属性编写属性测试
- 更新受影响的现有测试
- 运行所有测试确保通过

### 步骤 4：验证一致性
- 代码实现与设计文档一致
- 测试覆盖设计文档中的正确性属性
- 所有测试通过
- 文档清晰易懂

## 检查清单

在完成代码变更后，使用此检查清单：

- [ ] 代码变更已完成并通过编译
- [ ] 设计文档已更新（如有架构/接口/数据模型变更）
- [ ] 正确性属性已审查并更新（如有必要）
- [ ] 单元测试已编写/更新
- [ ] 属性测试已编写/更新（对应设计文档中的属性）
- [ ] 所有测试通过
- [ ] 测试标注了验证的需求编号
- [ ] 代码注释使用中文
- [ ] 文件大小符合规范（< 300 行）

## 特殊情况

### 快速修复 (Hotfix)
即使是紧急修复，也必须：
1. 修复代码
2. 更新或添加测试
3. 事后补充文档更新

### 实验性代码
如果是实验性功能：
1. 在设计文档中标注为"实验性"
2. 编写基本测试
3. 明确实验的目标和评估标准

### 重构
重构时：
1. 确保测试在重构前后都通过
2. 如果接口变更，更新设计文档
3. 如果只是内部实现变更，文档可能不需要更新

## 文档位置

- 需求文档：`.kiro/specs/{feature_name}/requirements.md`
- 设计文档：`.kiro/specs/{feature_name}/design.md`
- 任务列表：`.kiro/specs/{feature_name}/tasks.md`
- 测试代码：与源代码同目录或 `tests/` 目录

## 提醒

**记住：代码会说谎，但测试和文档不应该。保持三者同步是高质量软件的基础。**

当你完成代码变更时，问自己：
1. 设计文档还准确吗？
2. 测试覆盖了新的行为吗？
3. 其他开发者能通过文档理解我的变更吗？

如果答案是"否"，请立即更新相应文档。
