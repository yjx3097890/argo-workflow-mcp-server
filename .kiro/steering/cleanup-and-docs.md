---
inclusion: always
---

# 测试清理与文档生成规范

## 核心原则

在开发过程中保持代码库整洁，避免累积临时测试和不必要的文档。

## 测试清理规范

### 1. 临时测试的识别

以下类型的测试应被视为"临时测试"，需要及时清理：

- **调试测试**：仅用于验证某个 bug 修复的一次性测试
- **探索性测试**：用于探索 API 行为的实验性测试
- **重复测试**：与现有测试功能重复的测试
- **过时测试**：验证已删除功能的测试
- **简单示例测试**：仅用于演示基本用法的测试（应该在文档中展示，而非测试代码）

### 2. 清理时机

在以下情况下，必须主动清理临时测试：

- **完成功能开发后**：移除调试过程中创建的临时测试
- **重构后**：删除被新测试替代的旧测试
- **代码审查前**：确保只保留有价值的测试
- **任务完成时**：检查是否有遗留的临时测试

### 3. 保留的测试

以下测试应该保留：

- **单元测试**：验证核心功能的测试
- **属性测试**：验证正确性属性的测试（标注了 `**Validates: Requirements X.Y**`）
- **集成测试**：验证组件协作的测试
- **回归测试**：防止已修复 bug 再次出现的测试
- **边界条件测试**：验证边界情况和错误处理的测试

### 4. 清理流程

```
1. 识别临时测试
   ↓
2. 确认测试价值
   ↓
3. 如果是临时测试 → 删除
   ↓
4. 如果有价值但重复 → 合并到现有测试
   ↓
5. 如果有价值且独特 → 保留并添加清晰注释
```

### 5. 测试命名规范

为了便于识别，临时测试应使用明确的命名：

```rust
// ❌ 不好的命名（难以识别是否临时）
#[test]
fn test_1() { }

#[test]
fn test_something() { }

// ✅ 好的命名（清晰表达测试目的）
#[test]
fn should_return_error_when_url_is_invalid() { }

#[test]
fn property_round_trip_preserves_data() { }
```

## 文档生成规范

### 1. 需要询问用户的文档类型

在生成以下类型的文档之前，**必须先询问用户是否需要**：

- **总结文档**：如 `SUMMARY.md`、`IMPLEMENTATION_SUMMARY.md`
- **变更日志**：如 `CHANGELOG.md`
- **迁移指南**：如 `MIGRATION.md`
- **架构决策记录**：如 `ADR.md`
- **性能报告**：如 `PERFORMANCE.md`
- **部署指南**：如 `DEPLOYMENT.md`（除非是项目必需的）
- **API 文档**：如果代码注释已经足够清晰

### 2. 不需要询问的文档

以下文档是开发必需的，可以直接创建或更新：

- **需求文档**：`.kiro/specs/{feature}/requirements.md`
- **设计文档**：`.kiro/specs/{feature}/design.md`
- **任务列表**：`.kiro/specs/{feature}/tasks.md`
- **README**：项目根目录的 `README.md`
- **代码注释**：源代码中的文档注释

### 3. 询问方式

当需要生成额外文档时，使用以下模板询问用户：

```
我注意到可以为这次变更生成一个 [文档类型]（例如：实现总结文档）。

这个文档会包含：
- [列出文档将包含的主要内容]

是否需要我创建这个文档？

选项：
1. 是，创建文档
2. 否，不需要
```

### 4. 文档清理

定期检查并清理过时的文档：

- **过时的总结文档**：如果内容已经过时且不再有参考价值
- **临时笔记**：开发过程中的临时记录
- **重复文档**：内容与其他文档重复的文档

## 执行检查清单

### 任务完成前检查

- [ ] 是否有临时测试需要删除？
- [ ] 是否有调试代码需要移除？
- [ ] 保留的测试是否都有清晰的命名和注释？
- [ ] 是否生成了不必要的文档？

### 生成文档前检查

- [ ] 这个文档是开发必需的吗？
- [ ] 如果不是必需的，是否已询问用户？
- [ ] 文档内容是否与现有文档重复？
- [ ] 文档是否会很快过时？

## 示例场景

### 场景 1：完成功能开发

```
✅ 正确做法：
1. 实现功能
2. 编写单元测试和属性测试
3. 删除调试过程中的临时测试
4. 更新设计文档（如有必要）
5. 询问用户是否需要实现总结文档

❌ 错误做法：
1. 实现功能
2. 编写大量测试（包括临时测试）
3. 直接生成实现总结文档
4. 保留所有测试和文档
```

### 场景 2：修复 Bug

```
✅ 正确做法：
1. 编写回归测试验证 bug
2. 修复 bug
3. 确认测试通过
4. 删除调试过程中的临时测试
5. 保留回归测试

❌ 错误做法：
1. 编写多个临时测试探索 bug
2. 修复 bug
3. 保留所有临时测试
4. 生成 bug 修复总结文档（未询问用户）
```

### 场景 3：重构代码

```
✅ 正确做法：
1. 确保现有测试通过
2. 进行重构
3. 更新受影响的测试
4. 删除不再相关的旧测试
5. 确认所有测试通过

❌ 错误做法：
1. 重构代码
2. 保留所有旧测试和新测试
3. 生成重构总结文档（未询问用户）
```

## 自动化建议

可以使用以下命令检查测试文件大小，识别可能包含过多临时测试的文件：

```bash
# 查找超过 500 行的测试文件
find . -name "*test*.rs" -exec wc -l {} \; | awk '$1 > 500'

# 查找包含 "test_1"、"test_2" 等临时命名的测试
rg "fn test_\d+\(" --type rust
```

## 记住

**保持代码库整洁是持续的工作，而不是一次性的任务。**

- 临时测试就像临时变量，用完就删
- 文档应该有价值且保持更新，否则不如不写
- 询问用户是尊重他们的选择，避免产生不必要的工作

**原则：只保留有长期价值的测试和文档。**
